From e37f11db76b80c77e5e73a82f7943b70af1368c8 Mon Sep 17 00:00:00 2001
From: Ruslan Shymkevych <ruslan_shymkevych@epam.com>
Date: Fri, 22 Nov 2024 14:35:27 +0000
Subject: [PATCH] net: rswtich: disable GWCA when removing driver

We need to disable GWCA for two reasons:

1. There may be packets coming to the device when U-Boot already
transferred control to Linux, but Linux didn't had chance to
re-configure GWCA. This may lead to memory corruption, as chains are
already active.

2. Linux will not be able to switch GWCA to DISABLED state, because
transition from OPERATION to DISABLED requires that all buffer
pointers are released and all transactions are finished. But there are
no one who can handle those operations, as U-Boot already exited and
Linux is still trying to initialize R-Switch driver.

This fixes issue with DomD unable to initialize network in the
parallel mode.

Signed-off-by: Volodymyr Babchuk <volodymyr_babchuk@epam.com>
---
 drivers/net/rswitch.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/drivers/net/rswitch.c b/drivers/net/rswitch.c
index db7306c308..fc1428b054 100644
--- a/drivers/net/rswitch.c
+++ b/drivers/net/rswitch.c
@@ -1192,6 +1192,7 @@ static int rswitch_free_pkt(struct udevice *dev, uchar *packet, int length)
 static void rswitch_stop(struct udevice *dev)
 {
 	struct rswitch_priv *priv = dev_get_priv(dev);
+	int ret;
 
 	if (!priv->parallel_mode)
 		phy_shutdown(priv->etha.phydev);
@@ -1337,6 +1338,11 @@ static int rswitch_remove(struct udevice *dev)
 		mdio_unregister(priv->etha.bus);
 	}
 
+	/* Turn off GWCA to make sure that there will be no new packets */
+	ret = rswitch_gwca_change_mode(priv, GWMC_OPC_DISABLE);
+	if (ret)
+		pr_err("Failed to disable GWCA: %d\n", ret);
+
 	unmap_physmem(priv->addr, MAP_NOCACHE);
 	unmap_physmem(priv->etha.serdes_addr, MAP_NOCACHE);
 
-- 
2.25.1

