From b1f4fea9fbb08401892524963a2cb7d08fe57d07 Mon Sep 17 00:00:00 2001
From: Marek Vasut <marek.vasut+renesas@gmail.com>
Date: Sat, 17 Apr 2021 04:18:54 +0200
Subject: [PATCH 1/4] Revert "rcar_gen3: plat: Delete FDT function calls"

This reverts commit 3ebd371fa1b1137ddee85b1825d1c1ce31c719d1.
---
 plat/renesas/rcar/bl2_plat_setup.c | 27 ++++++++-------------------
 1 file changed, 8 insertions(+), 19 deletions(-)

diff --git a/plat/renesas/rcar/bl2_plat_setup.c b/plat/renesas/rcar/bl2_plat_setup.c
index 34337832c..fc657a44d 100644
--- a/plat/renesas/rcar/bl2_plat_setup.c
+++ b/plat/renesas/rcar/bl2_plat_setup.c
@@ -114,7 +114,6 @@ static meminfo_t bl2_tzram_layout __aligned(CACHE_WRITEBACK_GRANULE);
 
 /* FDT with DRAM configuration */
 uint64_t fdt_blob[PAGE_SIZE_4KB / sizeof(uint64_t)];
-#if 0
 static void *fdt = (void *)fdt_blob;
 
 static void unsigned_num_print(unsigned long long int unum, unsigned int radix,
@@ -138,7 +137,7 @@ static void unsigned_num_print(unsigned long long int unum, unsigned int radix,
 	while (--i >= 0)
 		*string++ = num_buf[i];
 }
-#endif
+
 #if (RCAR_LOSSY_ENABLE == 1)
 typedef struct bl2_lossy_info {
 	uint32_t magic;
@@ -150,7 +149,6 @@ static void bl2_lossy_gen_fdt(uint32_t no, uint64_t start_addr,
 			      uint64_t end_addr, uint32_t format,
 			      uint32_t enable, int fcnlnode)
 {
-#if 0
 	const uint64_t fcnlsize = cpu_to_fdt64(end_addr - start_addr);
 	char nodename[40] = { 0 };
 	int ret, node;
@@ -205,7 +203,6 @@ static void bl2_lossy_gen_fdt(uint32_t no, uint64_t start_addr,
 		NOTICE("BL2: Cannot add FCNL formats prop (ret=%i)\n", ret);
 		panic();
 	}
-#endif
 }
 
 static void bl2_lossy_setting(uint32_t no, uint64_t start_addr,
@@ -480,7 +477,6 @@ struct meminfo *bl2_plat_sec_mem_layout(void)
 	return &bl2_tzram_layout;
 }
 
-#if 0
 static void bl2_populate_compatible_string(void *dt)
 {
 	uint32_t board_type;
@@ -569,17 +565,13 @@ static void bl2_populate_compatible_string(void *dt)
 		panic();
 	}
 }
-#endif
 
 static void bl2_advertise_dram_entries(uint64_t dram_config[8])
 {
-#if 0
 	char nodename[32] = { 0 };
-	uint64_t fdtsize;
-	int ret, node;
-#endif
 	uint64_t start, size;
-	int chan;
+	uint64_t fdtsize;
+	int ret, node, chan;
 
 	for (chan = 0; chan < 4; chan++) {
 		start = dram_config[2 * chan];
@@ -592,7 +584,7 @@ static void bl2_advertise_dram_entries(uint64_t dram_config[8])
 			(size >> 30) ? : size >> 20,
 			(size >> 30) ? "G" : "M");
 	}
-#if 0
+
 	/*
 	 * We add the DT nodes in reverse order here. The fdt_add_subnode()
 	 * adds the DT node before the first existing DT node, so we have
@@ -640,7 +632,6 @@ static void bl2_advertise_dram_entries(uint64_t dram_config[8])
 err:
 	NOTICE("BL2: Cannot add memory node to FDT (ret=%i)\n", ret);
 	panic();
-#endif
 }
 
 static void bl2_advertise_dram_size(uint32_t product)
@@ -983,7 +974,7 @@ lcm_state:
 		}
 		rcar_qos_init();
 	}
-#if 0
+
 	/* Set up FDT */
 	ret = fdt_create_empty_tree(fdt, sizeof(fdt_blob));
 	if (ret) {
@@ -993,7 +984,7 @@ lcm_state:
 
 	/* Add platform compatible string */
 	bl2_populate_compatible_string(fdt);
-#endif
+
 	/* Print DRAM layout */
 	bl2_advertise_dram_size(product);
 
@@ -1045,14 +1036,14 @@ lcm_state:
 	}
 #if (RCAR_LOSSY_ENABLE == 1)
 	NOTICE("BL2: Lossy Decomp areas\n");
-#if 0
+
 	fcnlnode = fdt_add_subnode(fdt, 0, "reserved-memory");
 	if (fcnlnode < 0) {
 		NOTICE("BL2: Cannot create reserved mem node (ret=%i)\n",
 			fcnlnode);
 		panic();
 	}
-#endif
+
 	bl2_lossy_setting(0, LOSSY_ST_ADDR0, LOSSY_END_ADDR0,
 			  LOSSY_FMT0, LOSSY_ENA_DIS0, fcnlnode);
 	bl2_lossy_setting(1, LOSSY_ST_ADDR1, LOSSY_END_ADDR1,
@@ -1061,10 +1052,8 @@ lcm_state:
 			  LOSSY_FMT2, LOSSY_ENA_DIS2, fcnlnode);
 #endif
 
-#if 0
 	fdt_pack(fdt);
 	NOTICE("BL2: FDT at %p\n", fdt);
-#endif
 
 	if (boot_dev == MODEMR_BOOT_DEV_EMMC_25X1 ||
 	    boot_dev == MODEMR_BOOT_DEV_EMMC_50X8)
-- 
2.30.2

